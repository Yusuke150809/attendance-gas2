<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <?!= HtmlService.createHtmlOutputFromFile('css').getContent(); ?>
    <style>
      .fb-table { width: 100%; border-collapse: collapse; margin-top: 12px; }
      .fb-table th, .fb-table td { border: 1px solid #ccc; padding: 6px 8px; }
      .fb-input { width: 100%; box-sizing: border-box; }
      .fb-status { font-size: 12px; color: green; }
      .filter-bar { margin:12px 0; display:flex; gap:8px; flex-wrap:wrap; }
      .filter-bar input, .filter-bar select {
        padding:4px 6px; border:1px solid #ccc; border-radius:4px;
      }
    </style>
    <script>
      
      window.addEventListener('load', function() {
        google.script.run.withSuccessHandler(render).getLessonSessions();
      });

      // å–å¾—â†’ä¿æŒâ†’ãƒ†ãƒ¼ãƒ–ãƒ«ã¸
      function render(sessions) {
        window.sessionData   = sessions || [];
        window.filteredData  = sessions || [];
        renderTable(window.filteredData);
      }

      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å‡¦ç† 
      function applyFilter(){
        var startQ = document.getElementById("filter_start").value.trim();
        var endQ   = document.getElementById("filter_end").value.trim();
        var empQ   = document.getElementById("filter_emp").value.trim().toLowerCase();
        var subjQ  = document.getElementById("filter_subj").value.trim().toLowerCase();

        window.filteredData = window.sessionData.filter(function(s){
          var ok = true;
          if (startQ && (!s.start || s.start.indexOf(startQ) === -1)) ok = false;
          if (endQ   && (!s.end   || s.end.indexOf(endQ)   === -1)) ok = false;
          if (empQ   && (!s.empName || s.empName.toLowerCase().indexOf(empQ) === -1)) ok = false;
          if (subjQ  && (!s.subject || s.subject.toLowerCase().indexOf(subjQ) === -1)) ok = false;
          return ok;
        });
        renderTable(window.filteredData);
      }

      function renderTable(sessions){
        var tbody = document.getElementById('sessions');
        if (!Array.isArray(sessions) || sessions.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6">è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>';
          return;
        }

        var html = '';
        for (var i = 0; i < sessions.length; i++) {
          var s = sessions[i].start   || '';
          var e = sessions[i].end     || '';
          var emp = sessions[i].empName || 'â€”';
          var subj = sessions[i].subject || 'â€”';
          var fb = sessions[i].feedback || '';
          var answered = sessions[i].answered || 'æœªå›ç­”';

          html += '<tr>'
                +   '<td>' + s + '</td>'
                +   '<td>' + e + '</td>'
                +   '<td>' + emp + '</td>'
                +   '<td>' + subj + '</td>'
                +   '<td>'
                +     '<input type="text" class="fb-input" value="'+ fb +'" '
                +       'oninput="saveFeedback('+i+', this.value)">'
                +     '<div id="fb_status_'+i+'" class="fb-status"></div>'
                +   '</td>'
                +   '<td>' + answered + '</td>'
                + '</tr>';
        }
        tbody.innerHTML = html;
      }

      //  ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ä¿å­˜
      function saveFeedback(index, value){
        var session = window.filteredData[index]; // ãƒ•ã‚£ãƒ«ã‚¿å¾Œã®è¡Œã«å¯¾å¿œ
        if (!session) return;
        google.script.run
          .withSuccessHandler(function(msg){
            document.getElementById("fb_status_"+index).textContent = "ä¿å­˜ã—ã¾ã—ãŸ âœ”";
          })
          .withFailureHandler(function(err){
            document.getElementById("fb_status_"+index).textContent = "ä¿å­˜å¤±æ•—: " + (err && err.message ? err.message : err);
          })
          .saveFeedback(session.row, value);
      }
    </script>
  </head>

  <body>
    <h3>ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒšãƒ¼ã‚¸ï¼ˆå¾“æ¥­å“¡ç”¨ï¼‰</h3>

    <div>å¾“æ¥­å“¡: <span id="empName"><?= getEmployeeName() ?></span></div>
    <div>ç”Ÿå¾’å: <span id="selectedStudent"><?= getSelectedStudent() ?></span></div>

    <!-- ğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒãƒ¼ -->
    <div class="filter-bar">
      <input type="text" id="filter_start" placeholder="é–‹å§‹æ™‚é–“ã§æ¤œç´¢" oninput="applyFilter()">
      <input type="text" id="filter_end"   placeholder="çµ‚äº†æ™‚é–“ã§æ¤œç´¢" oninput="applyFilter()">
      <input type="text" id="filter_emp"   placeholder="æ‹…å½“å¾“æ¥­å“¡ã§æ¤œç´¢" oninput="applyFilter()">
      <input type="text" id="filter_subj"  placeholder="ç§‘ç›®ã§æ¤œç´¢" oninput="applyFilter()">
    </div>

    <table class="fb-table">
      <thead>
        <tr>
          <th>æˆæ¥­é–‹å§‹æ™‚é–“</th>
          <th>çµ‚äº†æ™‚é–“</th>
          <th>æ‹…å½“å¾“æ¥­å“¡</th>
          <th>ç§‘ç›®</th>
          <th>ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</th>
          <th>å›ç­”çŠ¶æ³</th>
        </tr>
      </thead>
      <tbody id="sessions">
        <tr><td colspan="6">èª­ã¿è¾¼ã¿ä¸­â€¦</td></tr>
      </tbody>
    </table>

    <div class="btn-frame" style="margin-top:16px;">
      <a href="<?= getAppUrl() ?>?empId=<?= getSelectedEmpId() ?>">ã‚¿ã‚¤ãƒ ãƒ¬ã‚³ãƒ¼ãƒ€ãƒ¼ã¸æˆ»ã‚‹</a>
      <a href="<?= getAppUrl() ?>">ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹</a>
    </div>
  </body>
</html>
