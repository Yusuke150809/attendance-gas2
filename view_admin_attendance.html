<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <?!= HtmlService.createHtmlOutputFromFile('css').getContent(); ?>
    <script>
      function loadAttendanceData() {
        google.script.run
          .withSuccessHandler(renderAttendanceCards)
          .withFailureHandler(function(error) {
            console.error('Error loading attendance data:', error);
            document.getElementById('attendance-container').innerHTML = 
              '<p style="color: red;">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
          })
          .getAllEmployeesAttendanceStatus();
      }
      
      function renderAttendanceCards(employeesData) {
        var container = document.getElementById('attendance-container');
        
        if (!employeesData || employeesData.length === 0) {
          container.innerHTML = '<p>å¾“æ¥­å“¡ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
          return;
        }
        
        var html = '<div class="attendance-cards">';
        
        employeesData.forEach(function(emp) {
          var statusClass = 'status-' + emp.status;
          var lastActionText = emp.lastAction && emp.lastTime ? 
            'æœ€çµ‚å‹•ä½œ: ' + emp.lastAction + ' (' + emp.lastTime + ')' : 
            'æ‰“åˆ»è¨˜éŒ²ãªã—';
          
          // Safely escape HTML content
          var empName = String(emp.name || '').replace(/[<>&"]/g, function(m) {
            return {'<':'&lt;', '>':'&gt;', '&':'&amp;', '"':'&quot;'}[m];
          });
          var empId = String(emp.id || '').replace(/[<>&"]/g, function(m) {
            return {'<':'&lt;', '>':'&gt;', '&':'&amp;', '"':'&quot;'}[m];
          });
          var statusText = String(emp.statusText || 'ğŸ”´ æˆæ¥­çµ‚äº†');
            
          html += '<div class="attendance-card">' +
                    '<div class="status-badge ' + statusClass + '">' + statusText + '</div>' +
                    '<div class="employee-info">' +
                      '<div class="employee-name">' + empName + '</div>' +
                      '<div class="employee-id">ID: ' + empId + '</div>' +
                      '<div class="last-action">' + lastActionText + '</div>' +
                    '</div>' +
                  '</div>';
        });
        
        html += '</div>';
        container.innerHTML = html;
      }
      
      window.addEventListener('load', loadAttendanceData);
    </script>
  </head>
  <body>
    <div class="company-title">é–‹ç™ºå¡¾ - å‹¤å‹™çŠ¶æ³ãƒšãƒ¼ã‚¸</div>
    <p>è¬›å¸«ã®å‹¤å‹™çŠ¶æ³ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç¢ºèªã§ãã¾ã™ã€‚</p>
    
    <div id="attendance-container">
      <p>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
    </div>

    <div class="btn-frame" style="margin-top:16px;">
      <button onclick="loadAttendanceData()" class="btn">æ›´æ–°</button>
      <a href="<?= getAppUrl() ?>?page=admin">å¡¾é•·ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</a>
      <a href="<?= getAppUrl() ?>">ãƒ›ãƒ¼ãƒ ç”»é¢ã«æˆ»ã‚‹</a>
    </div>
  </body>
</html>
